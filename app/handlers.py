import hashlib
import json
import os
import re

from aiogram import Router, F
from aiogram.enums import ParseMode
from aiogram.types import Message, CallbackQuery, ReplyKeyboardRemove
from aiogram.filters import CommandStart, or_f, Command
from aiogram.fsm.context import FSMContext
from aiogram.filters.state import State, StatesGroup, StateFilter
from aiogram import Bot
from dotenv import load_dotenv

import app.keyboards as kb
from app.change_price import Settings
from app.geolocation import coords_to_address, addess_to_coords
from app.database.requests import set_user, set_order, get_all_orders, get_driver, active_driver, get_user, add_car
from filters.chat_type import ChatTypeFilter
from app.calculate import length_way

router = Router()
router.message.filter(ChatTypeFilter(['private']))
load_dotenv()


# ----------------–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑---------------
@router.message(F.text == '–û—Ç–º–µ–Ω–∏—Ç—å')
async def cancel_order_reply(message: Message, state: FSMContext):
    await state.clear()
    await message.answer(f'–í—ã –æ—Ç–º–µ–Ω–∏–ª–∏ –∑–∞–∫–∞–∑. –ù–∞–∂–º–∏—Ç–∫–µ /start —á—Ç–æ–± –Ω–∞—á–∞—Ç—å –ø–æ–µ–∑–¥–∫—É', reply_markup=ReplyKeyboardRemove())


# ----------------–®–∞–≥ –Ω–∞–∑–∞–¥---------------
@router.callback_query(StateFilter('*'), F.data == 'backbutton_')
async def backbutton(callback: CallbackQuery, state: FSMContext):
    current_state = await state.get_state()

    previous = None
    for step in AddOrder.__all_states__:
        if step.state == current_state:
            await state.set_state(previous)
            await callback.answer('')
            await callback.message.edit_text(f'–í—ã –≤–µ—Ä–Ω—É–ª–∏—Å—å –∫ –ø—Ä–æ—à–ª–æ–º—É —à–∞–≥—É\n{AddOrder.texts[previous.state]}\n')
            return
        previous = step


# ----------------–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑---------------
@router.callback_query(F.data.startswith('cancelorder_'))
async def cancelorder(callback: CallbackQuery, state: FSMContext):
    await callback.answer('')
    await state.clear()
    await callback.message.delete()
    await callback.message.answer(f'–í—ã –æ—Ç–º–µ–Ω–∏–ª–∏')


class AddOrder(StatesGroup):
    point_start = State()
    point_end = State()
    finish = State()

    # coordinat_start_x = State()
    # coordinat_start_y = State()
    # coordinat_end_x = State()
    # coordinat_end_y = State()

    texts = {
        'AddOrder:point_start': '–í–≤–µ–¥–∏—Ç–µ –Ω–∞—á–∞–ª—å–Ω—É—é —Ç–æ—á–∫—É –∑–∞–Ω–æ–≤–æ',
        'AddOrder:point_end': '–í–≤–µ–¥–∏—Ç–µ –∫–æ–Ω–µ—á–Ω—É—é —Ç–æ—á–∫—É –∑–∞–Ω–æ–≤–æ',
    }


class AddUser(StatesGroup):
    phone = State()


@router.message(CommandStart())
async def cmd_start(message: Message, state: FSMContext):
    await state.clear()

    # –ü—Ä–æ–≤–µ—Ä–∫–∞, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–∞–∫—Å–∏—Å—Ç–æ–º
    drivers = await get_driver(message.from_user.id)
    if drivers and drivers.tg_id == message.from_user.id:
        await message.answer(f'<b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –¢–∞–∫—Å–∏—Å—Ç {message.from_user.full_name}</b>üòä\n\n',
                             reply_markup=await kb.driver_start_or_finish())
        # reply_markup = await kb.driver_start_or_finish()
        return

    tg_id = message.from_user.id
    user = await get_user(tg_id)

    if user:
        # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –µ—Å—Ç—å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö, –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ–º –µ–≥–æ
        await message.answer(f'<b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {message.from_user.full_name}!</b> üòä',
                             reply_markup=await kb.main())
    else:
        # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        await message.answer(f'–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Ç–∞–∫—Å–∏ –≥–æ—Ä–æ–¥–æ–∫!\n'
                             f'–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–≤–æ–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ c –ø–æ–º–æ—â—å—é –∫–Ω–æ–ø–∫–∏:',
                             reply_markup=await kb.phone())
        await state.set_state(AddUser.phone)


# –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—É—á–µ–Ω–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
@router.message(AddUser.phone, F.contact)
async def process_phone(message: Message, state: FSMContext):
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—É—á–µ–Ω–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    phone_number = message.contact.phone_number
    tg_id = message.from_user.id

    # –ó–∞–ø–∏—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    await set_user(tg_id, phone_number)

    # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–ø–∏—Å–∏
    await message.answer(f'–í—ã –∑–∞—Ä–µ–≥–µ—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å', reply_markup=ReplyKeyboardRemove())
    await message.answer(f'<b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {message.from_user.full_name}!</b> üòä',
                         reply_markup=await kb.main())
    await state.clear()


@router.message(AddUser.phone)
async def process_invalid_phone(message: Message):
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ª—É—á–∞—è, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —á—Ç–æ-—Ç–æ, –∫—Ä–æ–º–µ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    await message.answer('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞')


@router.callback_query(F.data == 'neworder')
async def neworder(callback: CallbackQuery, state: FSMContext, bot: Bot):
    await callback.answer('')
    await callback.message.edit_text(
        f'<b>üÖ∞Ô∏è: –ù–∞–ø–∏—à–∏—Ç–µ  –£–ª–∏—Ü—É –∏ ‚Ññ –¥–æ–º–∞\n'
        f'–ù–∞–ø—Ä–∏–º–µ—Ä: –Æ–∂–Ω–∞—è 8</b>',
        reply_markup=await kb.cancel_order())
    await state.set_state(AddOrder.point_start)


@router.message(AddOrder.point_start, F.text)
async def point_starter(message: Message, state: FSMContext):
    await state.update_data(point_start=message.text)
    data = await state.get_data()
    await message.answer(f'<b>üÖ∞Ô∏è: {data["point_start"]}\n\n'
                         f'üÖ±Ô∏è: –ù–∞–ø–∏—à–∏—Ç–µ –∫—É–¥–∞ –ø–æ–µ–¥–∏—Ç–µ?\n–ù–∞–ø—Ä–∏–º–µ—Ä: –õ–µ–Ω–∏–Ω–∞ 60;</b>',
                         reply_markup=await kb.back_button())
    await state.set_state(AddOrder.point_end)

    # try:
    #     if message.text:
    #         address_go = message.text
    #         longitude_end, latitude_end, trimmed_string = await addess_to_coords(address_go)
    #         print(trimmed_string)
    #         print(float(longitude_end), float(latitude_end))
    #     elif message.location:
    #         latitude_end = message.location.latitude
    #         longitude_end = message.location.longitude
    #         trimmed_string = await coords_to_address(longitude_end, latitude_end)
    #         print(float(longitude_end), float(latitude_end))
    #         print(trimmed_string)

    # except IndexError:
    #     await message.answer('–£–ª–∏—Ü–∞ –∏ –¥–æ–º –Ω–µ –∫–æ—Ä—Ä–µ—Ç–Ω–æ –≤–≤–µ–¥–µ–Ω—ã')
    #     await state.clear()
    #     full_name = message.from_user.full_name
    #     await message.answer(f'<b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å {full_name} </b>üòä', reply_markup=await kb.main())
    #     return
    #
    # await state.update_data(point_start=trimmed_string,
    #                         coordinat_start_x=float(longitude_end),
    #                         coordinat_start_y=float(latitude_end))
    # data = await state.get_data()
    # point = data.get('point_start')
    # await message.answer(f'<b>üÖ∞Ô∏è: {point}\n\n'
    #                      f'üÖ±Ô∏è: –ù–∞–ø–∏—à–∏—Ç–µ –∫—É–¥–∞ –ø–æ–µ–¥–∏—Ç–µ?\n–ù–∞–ø—Ä–∏–º–µ—Ä: –õ–µ–Ω–∏–Ω–∞ 60;</b>',
    #                      reply_markup=await kb.back_button())
    # await state.set_state(AddOrder.point_end)


@router.message(AddOrder.point_start)
async def point_start(message: Message, state: FSMContext):
    await message.answer(f'–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ—Ç–∫–Ω–æ –æ—Ç –∫—É–¥–∞ –µ–¥–∏—Ç–µ')


@router.message(AddOrder.point_end, F.text)
async def point_end(message: Message, state: FSMContext):
    await state.update_data(point_end=message.text, price=(100 + Settings.fix_price))
    data = await state.get_data()
    await message.answer(f"<b>üÖ∞Ô∏è: –ù–∞—á–∞–ª—å–Ω–∞—è —Ç–æ—á–∫–∞:</b> {data['point_start']}\n\n"
                         f"<b>üÖ±Ô∏è: –ö–æ–Ω–µ—á–Ω–∞—è —Ç–æ—á–∫–∞:</b> {data['point_end']}\n\n"
                         f"<b>–¶–µ–Ω–∞:</b> {data['price']}‚ÇΩ",
                         reply_markup=await kb.order_now())

    # try:
    #     if message.text:
    #         address_go = message.text
    #         longitude_end, latitude_end, trimmed_string = await addess_to_coords(address_go)
    #         print(trimmed_string)
    #         print(float(longitude_end), float(latitude_end))
    #     elif message.location:
    #         latitude_end = message.location.latitude
    #         longitude_end = message.location.longitude
    #         trimmed_string = await coords_to_address(longitude_end, latitude_end)
    #         print(float(longitude_end), float(latitude_end))
    #         print(trimmed_string)
    # except IndexError:
    #     await message.answer('–£–ª–∏—Ü–∞ –∏ –¥–æ–º –Ω–µ –∫–æ—Ä—Ä–µ—Ç–Ω–æ')
    #     await state.clear()
    #     full_name = message.from_user.full_name
    #     await message.answer(f'<b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å {full_name} </b>üòä', reply_markup=await kb.main())
    #     return
    # await state.update_data(point_end=trimmed_string,
    #                         coordinat_end_x=float(longitude_end),
    #                         coordinat_end_y=float(latitude_end))

    # point = data.get('point_start')
    # end = data.get('point_end')
    # await message.answer(f'<b>üÖ∞Ô∏è: {point}\n\n'
    #                      f'üÖ±Ô∏è: {end}\n\n</b>',
    #                      reply_markup=await kb.back_button())
    # data = await state.get_data()
    # distance, time_way, price = await length_way(data['coordinat_start_x'],
    #                                              data['coordinat_start_y'],
    #                                              data['coordinat_end_x'],
    #                                              data['coordinat_end_y'])
    # await state.update_data(distance=distance, time_way=time_way, price=price)
    # await message.answer(f"<b>üÖ∞Ô∏è: –ù–∞—á–∞–ª—å–Ω–∞—è —Ç–æ—á–∫–∞:</b> {data['point_start']}\n\n"
    #                      f"<b>üÖ±Ô∏è: –ö–æ–Ω–µ—á–Ω–∞—è —Ç–æ—á–∫–∞:</b> {data['point_end']}\n\n"
    #                      f"<b>–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ:</b> {distance}–∫–º\n\n"
    #                      f"<b>–í—Ä–µ–º—è –ø—É—Ç–∏:</b> {time_way}–º–∏–Ω\n\n"
    #                      f"<b>–¶–µ–Ω–∞:</b> {price}‚ÇΩ",
    #                      reply_markup=await kb.order_now())
    await state.set_state(AddOrder.finish)


@router.message(AddOrder.point_end)
async def point_end(message: Message, state: FSMContext):
    await message.answer('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ—Ç–∫–Ω–æ –∫—É–¥–∞ –µ–¥–∏—Ç–µ')


@router.callback_query(AddOrder.finish, F.data == 'order_now')
async def finish_price(callback: CallbackQuery, state: FSMContext, bot: Bot):
    await callback.answer('')
    data = await state.get_data()
    user_id = await get_user(callback.from_user.id)
    order_id = await set_order(user_id.id, data)
    order_data = await get_all_orders(order_id)
    await bot.send_message(chat_id=os.getenv('CHAT_GROUP_ID'),
                           text=f"–ó–∞–∫–∞–∑ <b>{order_id}</b>\n\n"
                                f"–¢–µ–ª–µ—Ñ–æ–Ω <b>+{user_id.phone}</b>\n\n"
                                f"–ù–∞—á–∞–ª—å–Ω–∞—è —Ç–æ—á–∫–∞: <b>{order_data.point_start}</b>\n\n"
                                f"–ö–æ–Ω–µ—á–Ω–∞—è —Ç–æ—á–∫–∞: <b>{order_data.point_end}</b>\n\n"
                           # f"<b>–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ:</b> {order_data.distance}–∫–º\n\n"
                           # f"<b>–í—Ä–µ–º—è –ø—É—Ç–∏:</b> {order_data.time_way}–º–∏–Ω\n\n"
                                f"–¶–µ–Ω–∞: <b>{order_data.price}–†</b>",
                           reply_markup=await kb.accept(order_id, callback.message.message_id))
    await callback.message.edit_text(f"<b>–û–∂–∏–¥–∞–π—Ç–µ –≤–æ–¥–∏—Ç–µ–ª—è‚åõ</b>\n\n"
                                     f"–ù–∞—á–∞–ª—å–Ω–∞—è —Ç–æ—á–∫–∞: <b>{order_data.point_start}</b>\n\n"
                                     f"–ö–æ–Ω–µ—á–Ω–∞—è —Ç–æ—á–∫–∞: <b>{order_data.point_end}</b>\n\n"
                                     # f"<b>–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ:</b> {order_data.distance}–∫–º\n\n"
                                     # f"<b>–í—Ä–µ–º—è –ø—É—Ç–∏:</b> {order_data.time_way}–º–∏–Ω\n\n"
                                     f"–¶–µ–Ω–∞: <b>{order_data.price}–†</b>")

    await state.clear()


@router.message(AddOrder.point_end)
async def point_end(message: Message, state: FSMContext):
    await message.answer('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ—Ç–∫–Ω–æ –∫—É–¥–∞ –µ–¥–∏—Ç–µ')


#-------------–æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º\–º–µ–Ω–µ–¥–∂–µ—Ä–∞–º
class SendMessage(StatesGroup):
    send_manager = State()
@router.message(Command('manager'))
async def send_manager_call(message: Message, state: FSMContext):
    await state.clear()
    await state.set_state(SendMessage.send_manager)
    await message.answer(f'üñäÔ∏è<b>–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä—É –¢–∞–∫—Å–∏ –≥–æ—Ä–æ–¥–æ–∫</b> üöï',
                                     reply_markup=await kb.cancel_order())

@router.message(SendMessage.send_manager)
async def get_manager(message: Message, state: FSMContext, bot: Bot):
    user = await get_user(message.from_user.id)
    if message.text:
        await state.update_data(send_manager=message.text)
        await bot.send_message(chat_id=os.getenv('CHAT_ID_ADMIN'),
                             text=f'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∏–∫ –Ω–µ–π–º: <b>{message.from_user.username}</b>\n'
                                  f'–ò–º—è: <b>{message.from_user.first_name}</b>\n'
                                  f'CHAT ID: <b>{message.from_user.id}</b>\n'
                                  f'–¢–µ–ª–µ—Ñ–æ–Ω: <b>+{user.phone}</b>\n'
                                  f'------------------------------\n'
                                  f'–°–æ–æ–±—â–µ–Ω–∏–µ:\n'
                                  f'<i>{message.text}</i>\n')
        await state.clear()
        await message.answer('–°–ø–∞—Å–∏–±–æ –∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ. –í —Å–∫–æ—Ä–æ–º –≤—Ä–µ–º–µ–Ω–∏ —Å –≤–∞–º–∏ —Å–≤—è–∂–µ—Ç—Å—è –º–µ–Ω–µ–¥–∂–µ—Ä',
                             reply_markup=await kb.main())

    elif message.voice:
        await state.update_data(send_manager=message.voice)
        await bot.send_voice(chat_id=os.getenv('CHAT_ID_ADMIN'),
                             caption=f'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∏–∫ –Ω–µ–π–º: <b>{message.from_user.username}</b>\n'
                                  f'–ò–º—è: <b>{message.from_user.first_name}</b>\n'
                                  f'CHAT ID: <b>{message.from_user.id}</b>\n'
                                  f'–¢–µ–ª–µ—Ñ–æ–Ω: <b>+{user.phone}</b>\n',
                             voice=message.voice.file_id)
        await state.clear()
        await message.answer('–°–ø–∞—Å–∏–±–æ –∑–∞ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. –í —Å–∫–æ—Ä–æ–º –≤—Ä–µ–º–µ–Ω–∏ —Å –≤–∞–º–∏ —Å–≤—è–∂–µ—Ç—Å—è –º–µ–Ω–µ–¥–∂–µ—Ä',
                             reply_markup=await kb.main())
    else:
        await message.answer('–û—Ç–ø—Ä–∞–≤—å —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –∏–ª–∏ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ')


# ----------------–ö–æ–º–∞–Ω–¥—ã –¥–ª—è –¢–∞–∫—Å–∏—Å—Ç–æ–≤---------------
# ----------------–í—ã–π—Ç–∏ –Ω–∞ –ª–∏–Ω–∏—é ---------------------
@router.callback_query(F.data.startswith('driverstart_'))
async def driver_start(callback: CallbackQuery):
    await callback.answer('')
    await active_driver(callback.message.chat.id, is_start=True)
    await callback.message.edit_text('–í—ã –≤—ã—à–ª–∏ –Ω–∞ –ª–∏–Ω–∏—é')


# ----------------–£–π—Ç–∏ —Å –ª–∏–Ω–∏–∏ –Ω–∞ –ª–∏–Ω–∏—é ---------------------
@router.callback_query(F.data.startswith('driverfinish_'))
async def driver_finish(callback: CallbackQuery):
    await callback.answer('')
    await active_driver(callback.message.chat.id, is_start=False)
    await callback.message.edit_text('–í—ã —É—à–ª–∏ —Å –ª–∏–Ω–∏–∏')


# –ø–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –≤ —Ç–∞–∫—Å–∏

class AddDrivercar(StatesGroup):
    phone = State()
    car_name = State()
    number_car = State()
    photo_car = State()


@router.message(Command('add_car'))
async def add_phone1(message: Message, state: FSMContext):
    await state.set_state(AddDrivercar.phone)
    await message.answer('–û—Ç–ø—Ä–∞–≤—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞', reply_markup=await kb.cancel_order())


@router.message(AddDrivercar.phone, F.text)
async def add_car_name(message: Message, state: FSMContext):
    await state.update_data(phone=message.text)
    await state.set_state(AddDrivercar.car_name)
    await message.answer('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ä–∫–∏ –º–∞—à–∏–Ω—ã', reply_markup=await kb.cancel_order())


@router.message(AddDrivercar.phone)
async def add_phone2(message: Message, state: FSMContext):
    await message.answer('–û—Ç–ø—Ä–∞–≤—å —Ç–µ–ª–µ—Ñ–æ–Ω —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É')


@router.message(AddDrivercar.car_name, F.text)
async def add_number_car(message: Message, state: FSMContext):
    await state.update_data(car_name=message.text)
    await state.set_state(AddDrivercar.number_car)
    await message.answer('–í–≤–µ–¥–∏—Ç–µ –≥–æ—Å –Ω–æ–º–µ—Ä –º–∞—à–∏–Ω—ã', reply_markup=await kb.cancel_order())


@router.message(AddDrivercar.car_name)
async def add_car_name(message: Message, state: FSMContext):
    await message.answer('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞—à–∏–Ω—ã')


@router.message(AddDrivercar.number_car, F.text)
async def add_tg_id(message: Message, state: FSMContext):
    await state.update_data(number_car=message.text)
    await state.set_state(AddDrivercar.photo_car)
    await message.answer('–û—Ç–ø—Ä–∞–≤—å —Ñ–æ—Ç–æ –º–∞—à–∏–Ω—ã', reply_markup=await kb.cancel_order())


@router.message(AddDrivercar.number_car)
async def add_number_car(message: Message, state: FSMContext):
    await message.answer('–û—Ç–ø—Ä–∞–≤—å –∫–æ—Ä—Ä–µ–∫–Ω–æ –≥–æ—Å –Ω–æ–º–µ—Ä')


@router.message(AddDrivercar.photo_car, F.photo)
async def add_item_category(message: Message, state: FSMContext, bot: Bot):
    message_user = message.from_user.id
    await state.update_data(photo_car=message.photo[-1].file_id, tg_id=message_user)
    data = await state.get_data()
    driver_id = await add_car(data)

    # await message.answer_photo(photo=data['photo_car'], caption=f"–¢–µ–ª–µ—Ñ–æ–Ω {data['phone']}")
    chat_admin = os.environ.get('CHAT_ID_ADMIN')
    await message.answer('–ú–∞—à–∏–Ω–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ')
    await bot.send_photo(chat_id=chat_admin,
                         photo=data['photo_car'],
                         caption=f'–†–≥–µ–∏—Å—Ç—Ä–∞—Ü–∏—è –∞–≤—Ç–æ–º–æ–±–∏–ª—è\n\n'
                                 f'–¢–µ–ª–µ—Ñ–æ–Ω:<b> {data["phone"]}</b>\n\n'
                                 f'–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—à–∏–Ω—ã: <b>{data["car_name"]}</b>\n\n'
                                 f'–ù–æ–º–µ—Ä –º–∞—à–∏–Ω—ã: <b>{data["number_car"]}–†</b>',
                         reply_markup=await kb.add_car_or_no(driver_id))
    await state.clear()


@router.message(AddDrivercar.photo_car)
async def phone(message: Message, state: FSMContext):
    await message.answer('–û—Ç–ø—Ä–∞–≤—å —Ñ–æ—Ç–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ')
